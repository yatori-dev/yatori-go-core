"use strict";

const produceXMLSerialization = require("w3c-xmlserializer");
const parse5 = require("parse5");
const DOMException = require("jsdom/lib/jsdom/living/generated/DOMException");
const { domSymbolTree } = require("jsdom/lib/jsdom/living/helpers/internal-constants");
const utils = require("jsdom/lib/jsdom/living/generated/utils");
const treeAdapter = require("jsdom/lib/jsdom/living/domparsing/parse5-adapter-serialization");
const NODE_TYPE = require("jsdom/lib/jsdom/living/node-type");

module.exports.fragmentSerialization = (node, { outer, requireWellFormed, globalObject }) => {
  const contextDocument =
    node.nodeType === NODE_TYPE.DOCUMENT_NODE ? node : node._ownerDocument;
  if (contextDocument._parsingMode === "html") {
    const config = {
      ...contextDocument._parseOptions,
      treeAdapter
    };
    return outer ? parse5.serializeOuter(node, config) : parse5.serialize(node, config);
  }

  const childNodes = outer ? [node] : domSymbolTree.childrenToArray(node);

  try {
    let serialized = "";
    for (let i = 0; i < childNodes.length; ++i) {
      serialized += produceXMLSerialization(
        utils.wrapperForImpl(childNodes[i]),
        { requireWellFormed }
      );
    }
    return serialized;
  } catch (e) {
    throw DOMException.create(globalObject, [e.message, "InvalidStateError"]);
  }
};
